<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
    <!--
<link rel="stylesheet" type="text/css" href="../css/issStyle1.css">
<script type="text/javascript" src="../css/issStyle.js"></script>
-->
<style type="text/css">
<!--

body
{
    margin-left:  30px;
    margin-right: 30px;
};

P
{
    font-family: Tahoma;
    font-size: 10pt;
};

a, a:visited, a:active, a:link, a:hover {
    text-decoration: underline;
    color: #545454;
    background-color: transparent;
}

a:hover {
    background-color: #cccccc;
}


hr {
    clear: both;
    height: 1px;
    color: #242424;
    background-color: transparent;
}

h1, h2, h3 {
    color: #242424;
    clear: left;
    font: 100% Tahoma, Helvetica, Arial, sans-serif;
    margin: 10;
    margin-right: 15px;
    margin-bottom: 0.5em;
    padding-top: 0.5em;
    border-bottom: 1px solid #242424;
}

h1 {
    font-size: 150%;
    background-color: #b2c0ff;
}

h2 {
    background-color: #d9fbff;
    font-size: 110%;
}

h3 {
	background-color: #e6ccff;
    font-size: 80%;
}
h4 {
    background-color: #99ffcc;
    font-size: 100%;
	width: 750px;
}
#i {
    color: #ff1010;
}
tt{
	font-family: "Arial";
    font-size: 80%;
	color: #006600;
}
em{
	font-family: "Arial";
    font-size: 80%;
	font-weight: bold;
	border-style:solid;
	border-color: #ccffff;
    color: #0033cc;
}
bc{
	font-family: "Arial";
	font-size: 80%;
	font-weight: bold;
    color: #990000;
	background-color: #fcf8c7;
}
pre{
	font-family: "Helvetica";
	font-size: 70%;
	background-color: #fcf8c7; 
}
m{
	font-family: "Helvetica";
	line-height: 100%;
 	font-size: 75%;
}
div.body{
	width: 800px;
    font-size: 18px;
}    
div.req{
	background-color: #d9ffb3;
    font-size: 18px;
	width: 700px;
    border: 3px solid green;
    padding: 15px;
    margin: 10px;
}    
div.remark{
	background-color: #FFFC33;     
    border: 3px solid green;
    padding: 15px;
    margin: 10px;
}  
table, th, td {
  border: 1px solid black;
  border-collapse: collapse;
}

  -->
</style>
    
<head>
   
<title>Lab10ISS</title></head>
    
<body>

<div class="body"> 

<h1>72939 - LAB10 | Using the QActor (meta)model</h1> 
<a href="http://htmlpreview.github.com/?https://github.com/anatali/iss2019Lab/blob/master/LectureBologna1819.html" target="isslm">LabISS-lectures site</a></font> 
 
 

<h2><a id=""/>Starting</h2>

<ol>
<li>Download <a href="https://www.eclipse.org/Xtext/download.html" target="web">Eclipse Xtext</a>  and Install Eclipse plugin for Kotlin.</li>
<li>Copy in <tt>dropins</tt> the files that constitute the support to the <bc>qak</bc> meta-model:<br/>
<bc>it.unibo.Qactork_1.0.0.jar</bc>, <bc>it.unibo.Qactork.ui_1.0.0.jar</bc>, <bc>it.unibo.Qactork.ide_1.0.0.jar</bc>.
<li>In an empty workspace, create a new project of type <tt>Kotlin project</tt> named <tt>it.unibo.eclipse.bls</tt>.</li>
<li>Set the gradle to our <em>Gradle User Home</em> (<tt>Windows->Preferences->Gradle</tt>) </li>
<li>In <tt>src</tt>, create a file with name <tt>bls.qak</tt></li>
</li>
</ol>
<p>
At this point, Eclipse should present the window:
</p>
<center><img src="./blsStarting.png" alt="blsStarting" width="50%" height="50%"></center>
<p>
This means that the installation is correct; after selecting <tt>Yes</tt>, the workspace looks as 
shown in the figure hereunder, on the left:
</p>
<center><table style="width:98%">
<tbody>	
<tr>
<td ><img src="./bls0.png" alt="bls0" width="100%" height="30%"></td>
<td><img src="./bls1.png" alt="bls1"  width="100%" height="30%"></td>
</tr>
</table>
</center>

 
<p>
The  <b>red dot</b> on the syntax driven edtor window means that there is an error, since the file cannot be empty.
If you press <em>CTRL-SPACE</em>, the system suggest the key word <bc>System</bc> that must be followed by
an identifier that will represent the name of our system. Let us write <tt>System bls</tt>
and then <em>save</em> the file. The workspace changes as  shown in the figure above, on the right.
</p>
The generated file <bc>bls.pl</bc> includes the description of the structure of the
system, as introduced in <a href="../../it.unibo.bls19d/userDocs/Lab6.html#infras" target="lecture">
Lab6.html#Towards an infrastructure</a>. At the moment the file includes just a comment, since the system model is
empty:

<pre>
%====================================== 
% bls description   
%====================================== 
</pre>



<h3><a id=""/>Hello world</h3>
<p>
As usually happens, our first example will be a qak-system that writes 'hello world'. Thus, let us write some
simple 'code' in the syntax driven editor window and save the file:
</p>
<center><table style="width:98%">
<tbody>	
<tr>
<td style="width:68%"><img src="./bls2.png" alt="bls0" width="100%" height="50%"></td>
<td><m>
The <tt>Qak-IDE</tt> generates:
<ul>
<li>A <bc>.gitignore</bc> and a 'generic' <bc>build.gradle</bc> file. 
<font size="2">To see the <tt>.XXX</tt> files you must act on the <b>Filters</b> command in the <tt>ViewMenu</tt></font>.</li>
<li>A  context-specific gradle file (<bc>build_XXX.gradle</bc>) for each context.</li>
<li>One package for each <tt>Context</tt> and for each <tt>QActor</tt>. Each package contains some source code written in <tt>Kotlin</tt>.</li>
<li>Each package related to a <tt>Context</tt> includes a class whose name starts with <bc>Main</bc>. This class includes the code that starts the actors
working in that context.</li>

</ul></m>
 </td>
</tr>
</table>
</center>
 
<ul>
<li>
At the moment, the <tt>Qak-IDE</tt> is not able to compile the source files since we must set the dependencies written in the 'generic' <bc>build.gradle</bc> file. 
To this end, open a terminal and write the command:

<pre>
gradle build eclipse	
</pre>
</li>
<li>Now the code should compile. If a <bc>!</bc> symbol appears on the project, open <tt>Project-> Properties->JavaBuidPath->src</tt> and 
eliminate the <tt>src</tt> duplicate.
</li>
<li>
At this point you can run the Main (in our case <bc>it.unibo.ctxBls.MainCtxBls.kt</bc>) and look at the result.
</li>

</ul>

<h2><a id=""/>The ButtonLed System</h2>

Our next next step is to define a Qak model for the ButtonLed system discussed in 
<a href="../../it.unibo.bls19d/userDocs/Lab5.html" target="lecture">Lab5.html (From objects to actors)</a>.
Under the pressure of 'saving time' we could decide to reuse actors that we already developed and tested.


<h3><a id=""/>A first (inappropriate) model</h3>

<p>
With reference to the actors developed in the project <bc>it.unibo.bls19d</bc>, we can extend the model as follows:


<pre>
System bls

Context ctxBls ip [host="localhost" port=8090]

QActor welcome context ctxBls{
	State s0 initial{
		println("---------------------------------------------------")
		println("Welcome to the BLS system described in qak (DSL)")
		println("---------------------------------------------------")
	} 
}
  
CodedQActor led     context ctxBls className "it.unibo.bls19d.qak.LedActork"        //FIRST
CodedQActor control context ctxBls className "it.unibo.bls19d.qak.ControlActork" 
CodedQActor button  context ctxBls className "it.unibo.bls19d.qak.ButtonActork"   //LAST
 
</pre>
This description says that:
<ol>
<li>Our system (<tt>bls</tt>) is composed of four actors (<tt>welcome, led, control, button</tt>). </li>
<li>All the actors work in a same computational node (<tt>ctxBls</tt>). </li>
<li>The actor <tt>welcome</tt> describes its behavior, while the other actors are directly expressed as <tt>Kotlin</tt> code.
Thus, we have to add in the file <bc>build_ctxBls.gradle</bc> a dependency to the library that includes such a code (<bc>it.unibo.bls19d-1.0.jar</bc>).
</li>
</ol>

If we save the model, the <tt>Qak-IDE</tt> generates (in file <tt>bls.pl</tt> ) the following description of the system:
<pre>
context(ctxbls, "localhost",  "TCP", "8090" ).

qactor( welcome, ctxbls, "it.unibo.welcome.Welcome").
qactor( led, ctxbls, "it.unibo.bls19d.qak.LedActork").
qactor( control, ctxbls, "it.unibo.bls19d.qak.ControlActork").
qactor( button, ctxbls, "it.unibo.bls19d.qak.ButtonActork").
</pre>

At this point, if we run the generated code <tt>it.unibo.ctxBls.MainCtxBls</tt>, the system immediately works.

<h4>Is it a good model?</h4>
Unfortunately, in the system described by the model above, there are many hidden details.  In particular:
<ol>
<li>the <tt>Kotlin</tt> code works by assuming that the <tt>led</tt> actor is created before 
the <tt>control</tt> that in its turn must be created before the <tt>button</tt>.
</li>
<li>the model does not show neither the interaction among the main actors nor their logical behavior.</li>
<li>the transition to a <bc>distributed version</bc> of the system is not possible, since  the <tt>Kotlin</tt> code 
is based on a class (<tt>SystemKb</tt>) that must be shared among all the actors.
</ol>

Thus, we can say that:

<div class="remark">
(Re)using actors written in <tt>Kotlin</tt> (or even conventional objects written in <tt>Java</tt>) cannot be excluded (for practical reasons), 
but a model should always <em>explicitly express</em> relevant aspects related to all the three main <bc>architectural dimensions</bc>
of a software system: <em>structure, interaction and behavior</em>.
</div>

Thus, let us express our model in a new way, so to explicitly express interaction and behavior related to the actors 
<tt>led, control</tt> and <tt>button</tt>.




</p>

<h3><a id=""/>A better model for the ButtonLed system</h3>



<center><table style="width:98%">
<tbody>	
<tr>
<td style="width:68%"><img src="./blsBetter.png" alt="blsBetter." width="100%" height="40%"/></td>
 <td><m>The model is in <a href="../src/blsBetter.qak" target="code">blsBetter.qak</a>.<br/>
Now the model explicitly declares:
<ol>
<li>the <bc>events</bc> and the <bc>messages</bc> used in the system; </li>
<li>a <tt>button</tt> actor that uses a custom object to generate the <tt>local_buttonCmd</tt> event; </li> 
<li>a <tt>control</tt> actor working as a <bc>proactive/reactive FSM</bc>  that 
intercepts <tt>local_buttonCmd</tt> events with a minimum delay
(the execution time of a <tt>forward</tt> operation);
<li>a <tt>led</tt> actor written in Kotlin (that handles  
<tt>ledCmd</tt> messages (this part is still hidden). </li> 
</li>
</ol> 
</m> 
 </td>
</tr>
</table>
</center>

<h5>About the Led</h5>
In this version, we still use the <tt>led</tt> actor defined in the old library  <bc>it.unibo.bls19d-1.0.jar</bc>. 
The important thing is that this actor is able to handle messages whose content is compatible 
(more precisely <em>Prolog-unifiable</em>) with our specification <tt>Dispatch ledCmd : ledCmd(X)</tt>. 

<h5>About the Button</h5>
 
The exact way used by the <tt>button</tt> actor to generate events of 'type' <tt>local_buttonCmd : local_buttonCmd(X)</tt>
is considered here a 'technological detail' that cab be hidden in a custom object.
Thus, the actor simply calls the method <bc>resources.bls.better.buttonEventEmitter.create()</bc> to create such an object,
whose code can be found  in <a href="../src/resources/bls/better/buttonEventEmitter.kt" target="code">buttonEventEmitter.kt</a>.


<h5>About <bc>whenTine</bc></h5>

The transition <bc>whenTine</bc> is implemented by creating in dynamic way a <bc>TimerActor</bc> that emits a system-event when the given time expires
(and afterwards terminates).
More details will be given when we'll discuss the work done by the <tt>Qak-IDE</tt> to translate the model into runnable code.

<h5>Running the system</h5>
If we launch the main program <a href="../src/it/unibo/ctxBlsBetter/MainCtxBlsBetter.kt" target="code">MainCtxBlsBetter.kt</a>,
the system will start its work. <br/><br/>
After some click on the button, we will see on the console a sequence of outputs of the form:

<pre>
it.unibo.bls19d.qak.LedActork led | UNKNOWN msg(local_tout_turnOn,event,timer,none,local_tout_turnOn,53)
it.unibo.bls19d.qak.LedActork led | UNKNOWN msg(local_buttonCmd,event,button,none,local_buttonCmd(clicked),57)
it.unibo.bls19d.qak.LedActork led | UNKNOWN msg(local_tout_turnOff,event,timer,none,local_tout_turnOff,58)
</pre>

These messages are written by the (reused) <tt>Led</tt> 
(see <a href="../../it.unibo.bls19d/src/main/kotlin/it/unibo/bls19d/qak/LedActork.kt" target="code">LedActork.kt</a>)
when it receives a message that it is not wants to handle.

<h4>Event-based behavior</h4>

Since the <tt>Qak-infrastructure</tt> (see <a href="../../it.unibo.bls19d/userDocs/Lab7.html#events" target="lecture">Lab7.html#events</a>) delivers an event 
to <b>all</b> the actors of the system, all the actors will receive any event.
<br/><br/>
However, the (meta-)model of actor behavior at the level of the DSL is <bc>event-based</bc> rather than <bc>event-driven</bc>. 
This means that there is a new intermediate infrastructural level (<bc>ActorBasicFsm</bc> and not ActorBasic) an actor that is not interested in handling an event will discard it
 
<pre>
QActor led context ctxBlsBetter {
	State s0 initial { 	}
	Transition t0 whenEvent ledCmd -> handleLedCmd
	 
	State  handleLedCmd{
		onMsg ( ledCmd : ledCmd(X) ) { println( "ledmock receives: ${meta_msgArg(0)}" ) }
	}
	Goto s0
}
</pre>

The  <tt>local_buttonCmd : local_buttonCmd(X)</tt> is discarded when <tt>led</tt> is a state 


<h2>From local to distributed</h2>

It is quite easy to change the configuration of the system, so to move one or more actors in different nodes.
For example, let us move the <tt>Led</tt> in another node:
<pre>
System bls
 
Context ctxBls ip [host="localhost" port=8090]
Context ctxLed ip [host="localhost" port=8095]

QActor welcome context ctxBls{ ... }

CodedQActor ctxLed context ctxBls className "it.unibo.bls19d.qak.LedActork"        //FIRST

CodedQActor control context ctxBls className "it.unibo.bls19d.qak.ControlActork" 
CodedQActor button context ctxBls className "it.unibo.bls19d.qak.ButtonActork"   //LAST
</pre>
In this case, the generated description (in file <tt>bls.pl</tt> ) becomes:
<pre>
context(ctxbls, "localhost",  "TCP", "8090" ).
context(ctxled, "localhost",  "TCP", "8095" ).

qactor( welcome, ctxbls, "it.unibo.welcome.Welcome").
qactor( led, ctxled, "it.unibo.bls19d.qak.LedActork").
qactor( control, ctxbls, "it.unibo.bls19d.qak.ControlActork").
qactor( button, ctxbls, "it.unibo.bls19d.qak.ButtonActork").
</pre>
</div>
<div style="background-color:rgba(86, 56, 253, 0.9); width:100%;text-align:center;font-size:small;color:white">
By AN Unibo-DISI    
</div> 
</body>
</html>